# https://philhawthorne.com/making-home-assistants-presence-detection-not-so-binary/

input_select:
  dennis_state:
    name: Dennis
    options:
      - Home
      - Just Arrived
      - Just Left
      - Away
      - Extended Away
    initial: Home
  jennifer_state:
    name: Jennifer
    options:
      - Home
      - Just Arrived
      - Just Left
      - Away
      - Extended Away
    initial: Home

sensor:
  - platform: template
    sensors:
      dennis_status:
        value_template: '{{ states.input_select.dennis_state.state }}'
        friendly_name: 'Dennis'
      jennifer_status:
        value_template: '{{ states.input_select.jennifer_state.state }}'
        friendly_name: 'Jennifer'

group:
  family_status:
    name: Family Status
    entities:
      - sensor.jennifer_status
      - sensor.dennis_status

automation:
  - alias: Mark person as just arrived
    trigger:
      - platform: state
        entity_id: device_tracker.dennis
        from: 'not_home'
        to: 'home'
      - platform: state
        entity_id: device_tracker.jennifer
        from: 'not_home'
        to: 'home'
    action:
      - service: input_select.select_option
        data_template:
          entity_id: >
            {% if trigger.entity_id == 'device_tracker.dennis' %}
              input_select.dennis_state
            {% else %}
              input_select.jennifer_state
            {% endif %}
          option: >
            {% if trigger.entity_id == 'device_tracker.dennis' %}
              {% if states.input_select.dennis_state.state == 'Just Left' %}
                Home
              {% else %}
                Just Arrived
              {% endif %}
            {% else %}
              {% if states.input_select.jennifer_state.state == 'Just Left' %}
                Home
              {% else %}
                Just Arrived
              {% endif %}
            {% endif %}
  - alias: Mark person as home
    trigger:
      - platform: state
        entity_id: input_select.dennis_state
        to: 'Just Arrived'
        for:
          minutes: 10
      - platform: state
        entity_id: input_select.jennifer_state
        to: 'Just Arrived'
        for:
          minutes: 10
      - platform: state
        entity_id: input_select.dennis_state
        from: 'Just Left'
        to: 'Just Arrived'
      - platform: state
        entity_id: input_select.jennifer_state
        from: 'Just Left'
        to: 'Just Arrived'
    action:
      - service: input_select.select_option
        data_template:
          entity_id: >
            {% if trigger.entity_id == 'input_select.dennis_state' %}
              input_select.dennis_state
            {% else %}
              input_select.jennifer_state
            {% endif %}
          option: Home
  
  - alias: Mark person as just left
    trigger:
      - platform: state
        entity_id: device_tracker.dennis
        from: 'home'
        to: 'not_home'
      - platform: state
        entity_id: device_tracker.jennifer
        from: 'home'
        to: 'not_home'
    action:
      - service: input_select.select_option
        data_template:
          entity_id: >
            {% if trigger.entity_id == 'device_tracker.dennis' %}
              input_select.dennis_state
            {% else %}
              input_select.jennifer_state
            {% endif %}
          option: Just Left
  
  - alias: Mark person as away
    trigger:
      - platform: state
        entity_id: input_select.dennis_state
        to: 'Just Left'
        for:
          minutes: 10
      - platform: state
        entity_id: input_select.jennifer_state
        to: 'Just Left'
        for:
          minutes: 10
    action:
      - service: input_select.select_option
        data_template:
          entity_id: >
            {% if trigger.entity_id == 'input_select.dennis_state' %}
              input_select.dennis_state
            {% else %}
              input_select.jennifer_state
            {% endif %}
          option: Away
  
  - alias: Mark person as extended away
    trigger:
      - platform: state
        entity_id: input_select.dennis_state
        to: 'Away'
        for:
          hours: 24
      - platform: state
        entity_id: input_select.jennifer_state
        to: 'Away'
        for:
          hours: 24
    action:
      - service: input_select.select_option
        data_template:
          entity_id: >
            {% if trigger.entity_id == 'input_select.dennis_state' %}
              input_select.dennis_state
            {% else %}
              input_select.jennifer_state
            {% endif %}
          option: Extended Away
